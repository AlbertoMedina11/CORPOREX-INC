'use strict';

var _ = require('lodash');
var fs = require('fs');
var vm = require('vm');
var path = require('path');

var run = module.exports;

run.runString = function runString(filename, fileContent, ext, callback) {
  try {
    vm.runInNewContext(fileContent, _.extend({}, global, ext), filename);
    callback(null);
  } catch (e) {
    if (e.constructor.name === 'SyntaxError') {
      e.message += '\n    at Object.<anonymous> (' + filename + ':?:?)';
    }
    callback(new e.constructor(e.message));
  }
}

run.runFile = function runFile(filename, ext, callback) {
  fs.readFile(filename, function (err, fileContent) {
    if (err) {
      return callback(new Error('Error reading file ' + filename));
    }

    run.runString(filename, fileContent.toString('utf8'), ext, callback);
  });
};
